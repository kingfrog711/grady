{% extends 'base.html' %}
{% load static %}

{% block meta %}
<title>Grady</title>
{% endblock meta %}

{% block content %}
{% include 'navbar.html' %}
<div class="bg-[#F8FAF7] w-full pt-16 min-h-screen text-[#1D3B24]">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-16">

    <div class="mb-8">
      <h1 class="text-3xl font-bold text-[#1D3B24] mb-2">Latest Football Products</h1>
      <p class="text-gray-600">Browse for the latest and freshest football gear</p>
    </div>
    <button onclick="showProductModal()"
      class="inline-flex items-center px-4 py-2 bg-white text-[#3B5E34] font-semibold outline outline-2 outline-[#3B5E34] outline-offset-[-2px] rounded-md hover:bg-[#3B5E34] hover:text-white transition-colors mb-4">
      Publish Product by AJAX
    </button>

    <div
      class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-10 bg-[#E6ECD8] rounded-lg border border-[#C5D5BA] shadow-md p-5">
      <div class="flex space-x-3 mb-4 sm:mb-0">
        <a href="?"
          class="{% if request.GET.filter == 'all' or not request.GET.filter  %} bg-[#3B5E34] text-white{% else %}bg-white text-[#1D3B24] border border-[#C5D5BA]{% endif %} px-5 py-2.5 rounded-md font-medium transition-colors hover:bg-[#1D3B24] hover:text-white text-base">
          All Products
        </a>
        <a href="?filter=my"
          class="{% if request.GET.filter == 'my' %} bg-[#3B5E34] text-white{% else %}bg-white text-[#1D3B24] border border-[#C5D5BA]{% endif %} px-5 py-2.5 rounded-md font-medium transition-colors hover:bg-[#1D3B24] hover:text-white text-base">
          My Products
        </a>
      </div>
      {% if user.is_authenticated %}
      <div class="text-sm text-gray-500">
        Last login: {{ last_login }}
      </div>
      {% endif %}
    </div>

    <div id="loading" class="bg-[#E6ECD8] rounded-lg border border-[#C5D5BA] p-16 text-center hidden">
      <svg class="animate-spin h-8 w-8 text-[#3B5E34] inline-block" xmlns="http://www.w3.org/2000/svg" fill="none"
        viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v4a4 4 0 00-4 4H4z"></path>
      </svg>
      <p class="text-gray-600 mt-3 text-lg">Loading products...</p>
    </div>

    <div id="error" class="hidden"></div>


    <div id="grid" class="hidden"></div>

    <div id="empty" class="bg-[#E6ECD8] rounded-lg border border-[#C5D5BA] p-16 text-center hidden">
      <div class="w-32 h-32 mx-auto mb-4">
        <img src="{% static 'image/no-product.png' %}" alt="No Items available" class="w-full h-full object-contain">
      </div>
      <h3 class="text-lg font-medium text-[#1D3B24] mb-2">No products found</h3>
      <p class="text-gray-600 mb-6">Be the first to publish a product for sale!</p>
      <a href="{% url 'main:publish_product' %}"
        class="inline-flex items-center px-4 py-2 bg-[#3B5E34] text-white rounded-md hover:bg-[#1D3B24] transition-colors font-medium">
        Publish Product
      </a>
    </div>
  </div>


  <script>
    // Configuration
    // Changed to reflect 'shop' model endpoints
    const SHOP_API_ENDPOINT = "{% url 'main:show_json' %}";
    const CURRENT_USER_ID = "{{ user.id|default_if_none:'' }}";
    const PUBLISH_PRODUCT_AJAX_ENDPOINT = "{% url 'main:publish_product_ajax' %}";


    // --- COLOR CONSTANTS ---
    const COLOR_MEDIUM_GREEN = 'bg-[#3B5E34]';
    const COLOR_DARK_GREEN = 'bg-[#1D3B24]';
    const COLOR_PALE_SAGE = 'bg-[#E6ECD8]';
    const COLOR_SUBTLE_BORDER = 'border-[#C5D5BA]';
    const TEXT_DARK_GREEN = 'text-[#1D3B24]';
    const HOVER_DARK_GREEN = 'hover:bg-[#1D3B24]';
    const HOVER_MEDIUM_GREEN_TEXT = 'hover:text-[#3B5E34]';

    // DOM Elements
    const loadingSpinner = document.getElementById('loading');
    const errorMessage = document.getElementById('error');
    const emptyStateDisplay = document.getElementById('empty');
    const productGridContainer = document.getElementById('grid');
    
    // Assuming modal form and button IDs remain product-centric for consistency
    const productForm = document.getElementById('productForm'); 
    const submitButton = document.getElementById('submitProduct'); 

    // State Variables
    const urlParams = new URLSearchParams(window.location.search);
    let activeFilter = urlParams.get('filter') === 'my' ? 'my' : 'all';
    
    let allProductData = [];

    // Show/hide page sections
    function displayPageSection({ showLoading = false, showError = false, showEmpty = false, showGrid = false }) {
      loadingSpinner.classList.toggle('hidden', !showLoading);
      errorMessage.classList.toggle('hidden', !showError);
      emptyStateDisplay.classList.toggle('hidden', !showEmpty);
      productGridContainer.classList.toggle('hidden', !showGrid);

      if (showGrid) {
        productGridContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8';
      }
    }

    // Get readable category name
    function getReadableCategoryName(categoryCode) {
      const categoryMapping = {
        jersey: 'Jersey',
        shoes: 'Football Shoes',
        ball: 'Football',
        accessories: 'Accessories',
        equipment: 'Training Equipment',
        fan_merch: 'Fan Merchandise'
      };
      return categoryMapping[categoryCode] || categoryCode;
    }

    // Create product card element - Item now represents a Shop instance
    function buildProductCardElement(Item) {
      const articleElement = document.createElement('article');
      articleElement.className = `${COLOR_PALE_SAGE} rounded-lg border ${COLOR_SUBTLE_BORDER} hover:shadow-2xl transition-shadow duration-300 overflow-hidden flex flex-col h-full`;

      // URLs updated to use 'shop' instead of 'product'
      const detailLink = `{% url 'main:shop_detail' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', Item.id);
      const editLink = `{% url 'main:edit_shop' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', Item.id);
      const deleteLink = `{% url 'main:delete_shop' '00000000-0000-0000-0000-000000000000' %}`.replace('00000000-0000-0000-0000-000000000000', Item.id);

      // Assuming the model fields remain 'released', 'stock', 'price', etc.
      const formattedDate = new Date(Item.released).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'short',
        day: 'numeric'
      });

      const categoryLabel = getReadableCategoryName(Item.category);
      const isFeatured = Item.is_featured;
      const isHot = Item.stock < 5;

      const thumbnailHtml = Item.thumbnail
        ? `<img src='${Item.thumbnail}' alt='${Item.name}' class='w-full h-full object-cover'>`
        : `<div class='w-full h-full bg-gradient-to-br from-[#C5D5BA] to-[#F8FAF7] flex items-center justify-center'></div>`;

      const categoryBadge = `<span class='inline-flex items-center px-2.5 py-0.5 rounded-md text-xs font-medium ${COLOR_MEDIUM_GREEN} text-white'>${categoryLabel}</span>`;

      const featuredBadge = isFeatured
        ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-yellow-100 text-yellow-800'>Featured</span>`
        : '';
      const hotBadge = isHot
        ? `<span class='inline-flex items-center px-2 py-1 rounded text-xs font-medium bg-red-100 text-red-800'>Low Stock</span>`
        : '';

      const editDeleteButtons = CURRENT_USER_ID && String(CURRENT_USER_ID) === String(Item.user_id)
        ? `<div class='flex space-x-2'>
        <a href='${editLink}' class='text-gray-600 ${HOVER_MEDIUM_GREEN_TEXT} text-sm transition-colors'>Edit</a>
        <a href='${deleteLink}' class='text-red-600 hover:text-red-700 text-sm transition-colors' onclick='return confirm("Are you sure you want to delete this item?")'>Delete</a>
      </div>`
        : '';

      const completeCardHtml = `
    <div class="aspect-[16/9] relative overflow-hidden">
      ${thumbnailHtml}
      <div class="absolute top-3 left-3">
        ${categoryBadge}
      </div>
      <div class="absolute top-3 right-3 flex space-x-2">
        ${featuredBadge}
        ${hotBadge}
      </div>
    </div>
    <div class="p-5 flex flex-col flex-1">
      <div class="flex items-center text-sm text-gray-600 mb-3">
        <time>Released: ${formattedDate}</time>
        <span class="mx-2">â€¢</span>
        <span>Rp ${Item.price.toLocaleString('id-ID')}</span>
      </div>
      <h3 class="text-lg font-semibold ${TEXT_DARK_GREEN} mb-3 line-clamp-2 leading-tight">
        <a href="${detailLink}" class="${HOVER_MEDIUM_GREEN_TEXT} transition-colors">${Item.name}</a>
      </h3>
      <p class="text-gray-600 text-sm leading-relaxed line-clamp-3 mb-4">${Item.description}</p>
      <div class="pt-4 border-t border-gray-300 flex items-center justify-between">
        <a href="${detailLink}" class="${HOVER_MEDIUM_GREEN_TEXT} font-medium text-sm transition-colors">View Details</a>
        ${editDeleteButtons}
      </div>
    </div>
  `;

      articleElement.innerHTML = completeCardHtml;
      return articleElement;
    }

    // Render all product cards
    function renderAllProductCards(Items) {
      productGridContainer.innerHTML = '';
      Items.forEach(Item => {
        const cardElement = buildProductCardElement(Item);
        productGridContainer.appendChild(cardElement);
      });
    }

    // Filter and display products 
    function filterAndDisplayProduct() {
      const filteredProducts = activeFilter === 'all'
        ? allProductData
        : allProductData.filter(item => String(item.user_id) === String(CURRENT_USER_ID));

      if (filteredProducts.length === 0) {
        displayPageSection({ showEmpty: true });
      } else {
        renderAllProductCards(filteredProducts);
        displayPageSection({ showGrid: true });
      }
    }

    // Fetch product data from server - uses SHOP_API_ENDPOINT
    async function fetchProductsFromServer() {
      try {
        displayPageSection({ showLoading: true });

        const response = await fetch(SHOP_API_ENDPOINT, { 
          headers: { 'Accept': 'application/json' },
        });

        if (!response.ok) {
          throw new Error('Failed to fetch shop data from server');
        }

        const productData = await response.json();
        allProductData = productData || []; 

        filterAndDisplayProduct(); 
      } catch (error) {
        console.error('Error loading shop items:', error);
        displayPageSection({ showError: true });
      }
    }

    // --- AJAX Submission Handler ---
    async function submitProductForm(event) {
      event.preventDefault();

      if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Publishing...';
      }

      const formData = new FormData(productForm); 
      const data = {};
      formData.forEach((value, key) => {
        data[key] = (key === 'is_featured') ? (value === 'on') : value;
      });

      const csrfTokenElement = productForm.querySelector('[name=csrfmiddlewaretoken]');
      const csrfToken = csrfTokenElement ? csrfTokenElement.value : '';

      try {
        // Use PUBLISH_PRODUCT_AJAX_ENDPOINT
        const response = await fetch(PUBLISH_PRODUCT_AJAX_ENDPOINT, { 
          method: 'POST',
          headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          showToast('Product published successfully!', 'success');
          productForm.reset(); 
          hideModal(); 
          await fetchProductsFromServer(); 
        } else {
          const errorData = await response.json();
          showToast(`Error: ${errorData.error || 'Validation Failed'}`, 'error');
        }

      } catch (error) {
        console.error('Submission failed:', error);
        showToast('An unexpected error occurred during submission.', 'error');
      } finally {
        if (submitButton) {
          submitButton.disabled = false;
          submitButton.textContent = 'Publish Product'; 
        }
      }
    }

    // Initialize page
    function initializeProductPage() {
      if (productForm) {
        productForm.addEventListener('submit', submitProductForm);
      }

      fetchProductsFromServer(); 
    }

    initializeProductPage();
  </script>
{% endblock content %}